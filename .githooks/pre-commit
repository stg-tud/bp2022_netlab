#!/bin/bash
set -e

changed_go_files=`git diff --cached --name-only *.go`

echo -n "Formatting files... "
if [[ -n "$changed_go_files" ]] ; then
    gofmt -w $changed_go_files
fi
echo "DONE"

echo -n "Checking format... "
if [[ -n "$changed_go_files"  && "$(gofmt -s -l ${changed_go_files} | wc -l)" -gt 0 ]]; then
    echo "FAIL"
    echo ""
    echo "Found formatting errors in these files:"
    gofmt -s -l ${changed_go_files}
    exit 1;
fi
echo "OK"

echo "Trying to build..."
go build ./...

echo "Running tests..."
go test ./...

echo "Ready to commit!"